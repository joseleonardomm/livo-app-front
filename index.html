<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda Digital - Iniciar Sesión</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Quitamos los scripts de Firebase compat y usaremos módulos ES6 -->
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-header">
            <div class="logo">
                <i class="fas fa-store"></i>
                <h1>Tienda Digital</h1>
            </div>
            <p class="tagline">Crea tu tienda online en minutos</p>
        </div>

        <div class="auth-tabs">
            <button class="tab-btn active" data-tab="login">Iniciar Sesión</button>
            <button class="tab-btn" data-tab="register">Registrarse</button>
        </div>

        <div class="auth-content">
            <!-- Formulario de Login -->
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Contraseña</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                </button>
                <div class="auth-links">
                    <a href="#" id="forgot-password">¿Olvidaste tu contraseña?</a>
                </div>
            </form>

            <!-- Formulario de Registro -->
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-store-name">Nombre de la Tienda</label>
                    <input type="text" id="register-store-name" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Contraseña</label>
                    <input type="password" id="register-password" required minlength="6">
                    <small>Mínimo 6 caracteres</small>
                </div>
                <div class="form-group">
                    <label for="register-confirm-password">Confirmar Contraseña</label>
                    <input type="password" id="register-confirm-password" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-user-plus"></i> Crear Cuenta
                </button>
            </form>

            <!-- Formulario de Recuperación -->
            <form id="recovery-form" class="auth-form">
                <div class="form-group">
                    <label for="recovery-email">Email</label>
                    <input type="email" id="recovery-email" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-envelope"></i> Enviar Instrucciones
                </button>
                <div class="auth-links">
                    <a href="#" id="back-to-login">Volver al inicio de sesión</a>
                </div>
            </form>
        </div>

        <div class="auth-footer">
            <p>© 2024 Tienda Digital. Todos los derechos reservados.</p>
        </div>
    </div>

    <script type="module">
        // Importar Firebase y funciones de autenticación
        import { auth } from './js/firebase.js';
        import { 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            updateProfile,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        
        import { 
            doc, 
            setDoc, 
            getDoc,
            collection,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        import { db } from './js/firebase.js';

        // Clase AuthManager actualizada para Firebase v9
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.initAuthStateListener();
            }

            // Escuchar cambios en el estado de autenticación
            initAuthStateListener() {
                onAuthStateChanged(auth, (user) => {
                    this.currentUser = user;
                    
                    // Si el usuario está logueado y está en index.html, redirigir a admin
                    if (user && window.location.pathname.includes('index.html')) {
                        window.location.href = 'admin.html';
                    }
                    
                    // Si no hay usuario y está en admin.html, redirigir a index
                    if (!user && window.location.pathname.includes('admin.html')) {
                        window.location.href = 'index.html';
                    }
                });
            }

            // Registro de nueva tienda
            async register(email, password, storeName) {
                try {
                    // Crear usuario en Firebase Auth
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // Crear documento de tienda en Firestore
                    const storeId = this.generateStoreId();
                    const storeData = {
                        ownerUid: user.uid,
                        storeInfo: {
                            name: storeName,
                            email: email,
                            whatsapp: '',
                            address: '',
                            mapLink: '',
                            logoUrl: '',
                            colors: {
                                primary: '#001f3f',
                                secondary: '#0074D9'
                            },
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        }
                    };
                    
                    await setDoc(doc(db, 'stores', storeId), storeData);
                    
                    // Guardar storeId en el perfil del usuario
                    await updateProfile(user, {
                        displayName: storeId
                    });
                    
                    return { success: true, storeId };
                } catch (error) {
                    console.error('Error en registro:', error);
                    throw error;
                }
            }

            // Login
            async login(email, password) {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    return { success: true };
                } catch (error) {
                    console.error('Error en login:', error);
                    throw error;
                }
            }

            // Recuperar contraseña
            async resetPassword(email) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    return { success: true };
                } catch (error) {
                    console.error('Error en reset password:', error);
                    throw error;
                }
            }

            // Cerrar sesión
            async logout() {
                try {
                    await auth.signOut();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Error en logout:', error);
                    throw error;
                }
            }

            // Obtener storeId del usuario actual
            getCurrentStoreId() {
                return auth.currentUser?.displayName || null;
            }

            // Generar ID único para la tienda
            generateStoreId() {
                return 'store_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // Verificar si el usuario es propietario de la tienda
            async verifyStoreOwnership(storeId) {
                try {
                    const user = auth.currentUser;
                    if (!user) return false;
                    
                    const storeDoc = await getDoc(doc(db, 'stores', storeId));
                    if (!storeDoc.exists()) return false;
                    
                    return storeDoc.data().ownerUid === user.uid;
                } catch (error) {
                    console.error('Error verificando propiedad:', error);
                    return false;
                }
            }
        }

        // Instancia global
        const authManager = new AuthManager();

        // Función de utilidad para mostrar notificaciones
        function showNotification(message, type = 'info', duration = 3000) {
            // Eliminar notificaciones anteriores
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            // Crear notificación
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation' : 'info'}-circle"></i>
                <span>${message}</span>
            `;
            
            // Estilos
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                background: ${type === 'success' ? '#2ECC40' : type === 'error' ? '#FF4136' : '#0074D9'};
                color: white;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            // Agregar animación
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Auto-eliminar
            setTimeout(() => {
                notification.remove();
                style.remove();
            }, duration);
        }

        // Validar email
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // Event listeners cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            // Tabs
            const tabBtns = document.querySelectorAll('.tab-btn');
            const authForms = document.querySelectorAll('.auth-form');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    
                    // Actualizar tabs activos
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Mostrar formulario correspondiente
                    authForms.forEach(form => form.classList.remove('active'));
                    document.getElementById(`${tab}-form`).classList.add('active');
                });
            });
            
            // Login
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                try {
                    await authManager.login(email, password);
                    showNotification('Inicio de sesión exitoso', 'success');
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            });
            
            // Registro
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('register-email').value;
                const storeName = document.getElementById('register-store-name').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                // Validaciones
                if (!validateEmail(email)) {
                    showNotification('Email no válido', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showNotification('La contraseña debe tener al menos 6 caracteres', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showNotification('Las contraseñas no coinciden', 'error');
                    return;
                }
                
                if (!storeName.trim()) {
                    showNotification('El nombre de la tienda es obligatorio', 'error');
                    return;
                }
                
                try {
                    const result = await authManager.register(email, password, storeName);
                    showNotification('Cuenta creada exitosamente', 'success');
                    
                    // Mostrar link de la tienda
                    setTimeout(() => {
                        const storeUrl = `${window.location.origin}/store.html?storeId=${result.storeId}`;
                        alert(`¡Tienda creada!\n\nTu tienda estará disponible en:\n${storeUrl}\n\nGuarda este enlace para compartir con tus clientes.`);
                    }, 1000);
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            });
            
            // Recuperación de contraseña
            document.getElementById('forgot-password').addEventListener('click', (e) => {
                e.preventDefault();
                authForms.forEach(form => form.classList.remove('active'));
                document.getElementById('recovery-form').classList.add('active');
            });
            
            document.getElementById('back-to-login').addEventListener('click', (e) => {
                e.preventDefault();
                authForms.forEach(form => form.classList.remove('active'));
                document.getElementById('login-form').classList.add('active');
                tabBtns.forEach(b => b.classList.remove('active'));
                document.querySelector('[data-tab="login"]').classList.add('active');
            });
            
            document.getElementById('recovery-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('recovery-email').value;
                
                try {
                    await authManager.resetPassword(email);
                    showNotification('Si este correo existe, se enviaron instrucciones', 'success');
                    
                    // Volver al login después de 3 segundos
                    setTimeout(() => {
                        authForms.forEach(form => form.classList.remove('active'));
                        document.getElementById('login-form').classList.add('active');
                        tabBtns.forEach(b => b.classList.remove('active'));
                        document.querySelector('[data-tab="login"]').classList.add('active');
                    }, 3000);
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            });
        });
    </script>
</body>
</html>